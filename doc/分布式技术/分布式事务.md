# 强一致事务

### XA 二阶段提交协议

XA 协议是一种两阶段提交协议 2PC ，他分两个阶段来完成分布式事务，在XA 协议中，首先会引入一个中间件，叫做事务管理器， 他是一个协调者，独立数据库的事务管理器称为本地资源管理器 

![image-20210926144148027](https://gitee.com/Sean0516/image/raw/master/img/image-20210926144148027.png)

​																									XA 协议第一阶段

1. 应用系统使用事务管理器，首先把数据发送给需要操作的分布式数据库，并且给予预备命令
2. 当分布式数据库得到数据和预备命令后，对数据进行锁定，保证不被其他事务干扰
3. 在本地资源管理器做好上一步后，对事务管理器提交就绪信息

正常情况下，事务管理器可以得到所有数据库提交的就绪信息，就能继续发起第二阶段命令，也就是提交命令

![image-20210926144857774](https://gitee.com/Sean0516/image/raw/master/img/image-20210926144857774.png)

​																								XA 协议第二阶段

1. 当事务管理器接收到XA 协议第一阶段得到的所有数据库的就绪信息后，就会对所有数据库发送提交命令
2. 当各个本地资源服务器接收到提交的命令时，就会将XA 协议第一阶段锁定的数据进行提交，然后释放锁定的数据
3. 当做完上一步后，本地资源管理器就会对事务管理器发送提交成功的信息，表名数据已经操作成功了

做完第二阶段的提交，所有数据都会被提交到各自的数据库中，各个数据库的数据就会保持一致性

### 三阶段提交协议 3PC

三阶段提交协议是在两阶段提交协议的基础上演变出来的，它只是增加了询问和超时的功能。询问功能是指在执行XA协议之前，对数据库连接和资源进行验证。超时功能是指数据库在执行XA协议的过程中锁定的资源，在超过一个时间戳后，会自动释放锁，避免死锁

![](https://gitee.com/Sean0516/image/raw/master/img/image-20210926145709102.png)



三阶段提交命令的本质和两阶段提交并无太多不同，只是多了以下两点

1. 增加询问阶段 ： 在执行两阶段前做一些询问和验证，如验证连接数据库是否成功，可通过执行简易查询SQL 是成功验证。 如果成功了，就继续执行，如果没成功，则中断执行。 这样就能在大大提高成功率的同时，减少出错的可能性
2. 增加超时机制， 在执行XA 协议的过程中，如果事务执行超时，则提交事务 在大部分情况下，提交事务的合理性要远远超过回滚事务。 这样操作的好处在于，可以防止数据库锁定资源，导致系统出现死锁的问题

无论是两阶段提交协议，还是三阶段提交协议，当前都不是企业保证一致性的主流技术了，原因大体有两个。第一，它们的实现相对来说比较复杂，日后维护和运维起来都比较困难。第二，使用了大量锁技术，在高并发的情况下，会造成大量的阻塞，导致用户体验不佳，影响用户的忠诚度。因此，两阶段和三阶段提交协议就都渐渐地没落了，取代它们的是弱一致性事务的技术



# 弱一致性事务

弱一致性是指当前用户对数据完成更新操作后，并不保证后续线程或者其他节点能够马上访问到最新的值， 一致性由后续操作保证。 弱一致的好处是，各个服务实例的操作可以在无锁的情况下进行，性能上没有损失，能迎合高并发的要求。 实现起来也相对简单灵活

一般来说，弱一致性会“尽可能”保证事务的一致性，但不能绝对保证，也就是说，使用弱一致性事务后，虽然数据可能会存在不一致的情况，但是不一致的情况会大大减少。弱一致性的方法很多，也没有固定的模式，常见的方法有状态表、可靠事件、补偿性事务和其衍生的TCC（Try Confirm Cancel）模式等。但是无论使用何种模式，都不能保证所有的数据都达到一致性，为了达到完全的一致性，一些企业还会有事后对账的机制



