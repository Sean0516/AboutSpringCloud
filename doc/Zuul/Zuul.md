Netflix Zuul是一个API网关，它的主要功能是提供网关服务。Netflix网站的超大数量和多样性，有时会导致生产中产生各种各样的问题，因为这些问题暴露得特别快，并且无任何警告，所以排错工作异常艰难，为了解决这些问题，需要有一个能够快速改变行为的系统，于是便有了Netflix Zuul。Netflix Zuul提供了一系列不同类型的过滤器（Filter），通过这些过滤器，系统维护人员能够快速灵活地过滤服务、限制流量、实现服务器的负载均衡，从而避免外部请求冲垮微服务系统（注意：断路器主要是内部服务调用并非外部请求）。Netflix Zuul提供的过滤器存在以下功能

- 身份验证  通过身份验证区分不同的权限
- 检验和安全：对请求的有效性进行验证，如短时间多次刷请求的恶意攻击、提供验证码等
- 限流  在高并发的场景下，限制请求通过的流量，避免过大的流量压垮源服务器
- 动态路由  根据需要将请求动态路由到不同的后端微服务
- 压力测试  通过增删后端微服务实例，来确定整体服务承担的流量
- 静态响应处理   对于处于高负荷的系统，提供静态资源作为服务的响应结果 （服务降级）
- 多区域弹性：类似亚马逊服务站（AWS），将请求路由到最近的服务站点，提高服务的性能

### 什么是网关

网关（gateway）是一种外部网络和内部服务之间的关卡，它可以最先得到外部的请求。从软硬件的区分来说，网关又可以分为硬件网关和软件网关。

![image-20210903155545492](https://gitee.com/Sean0516/image/raw/master/img/image-20210903155545492.png)

软件网关是微服务系统获取请求信息的第一个入口，它的作用是先对请求进行一定的条件过滤后，再分发到源服务器（也就是具体的微服务系统）。从表述可以知道，软件网关的作用大体分为两个：一个是请求过滤，一般可以做验证请求有效性，身份验证等；另一个是路由分发，可以做负载均衡策略。这里的负载均衡有别于第3章讲到的客户端负载均衡，区别如下：网关的负载均衡也被称为服务器负载均衡，它是针对微服务系统外部请求而言的；而客户端负载均衡则是对各个微服务业务系统之间的服务调用而言的。在网关的功能中，主要的核心是过滤器，所以它是学习网关的核心内容

因为网关最先得到请求，所以一般企业会将所有对微服务的请求先集中到网关，然后再分发，实现统一的请求入口

### Zuul 原理 -- 过滤器

Zuul的原理并非十分复杂，相反的，可能还算比较简单，它的本质就是一套Servlet的API。其中ZuulServlet是核心Servlet，它将接收各类请求。此外NetflixZuul还提供了ZuulServletFilter，它是一个拦截器，可以拦截各类请求。ZuulServlet和ZuulServletFilter就是Zuul的核心内容。为了更加方便地增加和删除拦截逻辑，在ZuulServlet和ZuulServletFilter的基础上，Netflix Zuul定义了自己的过滤器——ZuulFilter。而ZuulFilter就是本章的核心内容，基本网关大部分的逻辑都要通过它来实现

当我们继承ZuulFilter后，需要实现这4个方法，而系统中已经提供了许多ZuulFilter的实现类，它们已经实现了这4个抽象方法。下面我们来了解这4个方法的作用

- shouldFilter：是否执行过滤器逻辑，也就是可以根据上下文判定是否采用过滤器拦截请求。
- run：过滤器的具体逻辑，它是过滤器的核心方法，将返回一个Object对象，倘若返回为null，则表示继续后续的正常逻辑。
- filterType：过滤器类型，有4种类型可设置：“pre”“route”“post”和“error”。
- filterOrder：设置过滤器的顺序

 filterType方法返回的字符串代表的是过滤类型，该类型是以源服务器进行区分的。按其定义分为4种

- pre：在路由到源服务器前执行的逻辑，如鉴权、选择具体的源服务器节点和参数处理等，都可以在这里实现。

- route：执行路由到源服务器的逻辑，如之前我们谈到的Apache HttpClient或者Netflix Ribbon，当前也支持OKHttp。

- post：在路由到源服务器后执行的过滤器，常见的用法是把标准的HTTP响应头添加到响应中，此外也可以通过它来收集响应的度量数据，统计成功率，还可以对源服务器请求返回的数据再次加工，然后返回到客户端，等等。

- error：倘若在整个路由源服务器的执行的过程中发生异常，就可以进入此类过滤器，它可以做全局的响应逻辑处理错误

Zuul会将多个过滤器组织为一个责任链，那么各个过滤器会以什么顺序组织呢？这是由filterOrder方法决定的，它是返回一个数字，该数字越小，在过滤器链中就越优先执行